\section{semantics}
\label{sec:semantics}

In this section, we explain the formalization of the operational semantics of the Actor model in Actario.
First, for the explanation of formalization of operational semantics, we describe \lstinline|name| type, \lstinline|actor| type, \lstinline|in_flight_message| type, and \lstinline|config| type.
And then, we explain how to formalize the operational semantics in Actario.

\subsection{Actor Name}
In Actario, actor name is defined as the disjoint sum of the case of an actor with no parent and the case of an actor generated by another actor (Figure~\ref{coq:name}).
We call the actors having no parent \textit{top level actor}.
Top level actor represents initial actors in the system.
And we call the actors generated by another actor \textit{generated actor}.
The name of a generated actor consists of the name of parent actor and the number that the parent actor generated so far.
We call the number \textit{generation number}.
To keep name uniqueness, we introduce generation number.
For more detail about name uniqueness, see Section~\ref{sec:uniqueness}.

%% Actario ではアクターの名前は、親がいないアクターと何らかのアクターから生成されたアクターに分けて定義する (図\ref{coq:name})。
%% 親がいないアクターは toplevel actor と呼ぶ。
%% これはアクターシステムに最初から存在するアクターを表す。
%% 何らかのアクターから生成されたアクターを generated actor と呼ぶ。
%% generated actor の名前は、親アクターの名前と、その親アクターが何番目に生成した子かという番号 (generation number) のペアとする。
%% これは動的に生成されうるアクターの名前の一意性を保つためである。

\begin{figure}[t]
\begin{lstlisting}
Inductive name : Set :=
| toplevel : string -> name
| generated : nat -> name -> name.
\end{lstlisting}
\caption{name}\label{coq:name}
\end{figure}


\subsection{actor}
We explain how \lstinline|actor| is defined in Actario.
Actor consists of its name, sequence of remaining actions, and next generation number to use in generating next child (Figure~\ref{coq:actor}).
If remaining actions are only \textsf{become}, the actor is ready for receiving a message.
%% アクターは、自分自身名前、残りのアクションの列、次回アクターを生成する際に使う generation number の3つのレコード型である (図\ref{coq:actor})。
%% 残りのアクションの列が become のみの場合、このアクターはメッセージを受け取れる状態にあるということを表す。

\begin{figure}[t]
\begin{lstlisting}
Record actor := {
  actor_name : name;
  remaining_actions : actions;
  next_num : gen_number
}.
\end{lstlisting}
\caption{actor}\label{coq:actor}
\end{figure}

\subsection{in flight message}
Next, we define \lstinline|in_flight_message| type which represents messages in flight in the configuration.
\lstinline|in_flight_message| consists of the name of the destination, the name of the sender, and the content of the message (Figure~\ref{coq:inflight}).
%% 宛先と送り主とメッセージの内容からなるレコード型である (図\ref{coq:inflight}))。
%% まだ受け取られていないメッセージを表す。
%% configuration に用いる。

\begin{figure}[t]
\begin{lstlisting}
Record in_flight_message := {
  to : name;
  from : name;
  content : message
}.
\end{lstlisting}
\caption{in flight message}\label{coq:inflight}
\end{figure}

\subsection{configuration}
\textit{configuration} represents a snapshot of the actor system.
configuration is used to formulate operational semantics of the Actor model.
In Actario, a configuration consists of a list of actors and a list of messages in flight.

\begin{figure}[t]
\begin{lstlisting}
Record config := {
  in_flight_messages : list in_flight_message;
  actors : list actor
}.
\end{lstlisting}
\caption{config}\label{coq:config}
\end{figure}


\subsection{label}
Actario formulates operational semantics of the Actor model as labeled transition system, so we define label (Figure~\ref{coq:label}).
The explanations of each label are as follows.

%% Actario ではアクターモデルの操作的意味を labeled transition system として定式化するため、ラベルを定義する (図\ref{coq:label}))。
%% 以下にそれぞれの説明を示す。

\begin{description}[style=nextline,leftmargin=12pt,parsep=0pt]
\item[\texttt{Receive (to : name) (from : name) (content : message)}]
  This represents that the actor named \lstinline|to| receives the message \lstinline|content| sent from the actor named \lstinline|from|.
  %% \texttt{to} という名前のアクターが \texttt{from} という名前のアクターからのメッセージ \texttt{content} を受け取って遷移したということを表す。
\item[\texttt{Send (from : name) (to : name) (content : message)}]
  This represents that the actor named \lstinline|from| sends the message \lstinline|content| to the actor named \lstinline|to|.
  %% \texttt{from} という名前のアクターが \texttt{to} という名前のアクターに向けてメッセージ \texttt{content} を送ってシステムが遷移したということを表す。
\item[\texttt{New (child : name)}]
  This represents that the actor named \lstinline|child| is generated.
  %% \texttt{child} という名前の新しいアクターが生成されてシステムが遷移したということを表す。
\item[\texttt{Self (me : name)}]
  This represents that the actor named \lstinline|me| gets the name itself.
  %% \texttt{me} という名前のアクターが自分自身の名前を読みだしたということを表す。
\end{description}


\begin{figure}[t]
\begin{lstlisting}
Inductive label :=
| Receive (to : name) (from : name) (content : message)
| Send (from : name) (to : name) (content : message)
| New (child : name)
| Self (me : name).
\end{lstlisting}
\caption{label}\label{coq:label}
\end{figure}


\subsection{semantics}

We formulate operational semantics of the Actor model as labeled transition system.
For the later explanation, we define the symbols as shown in Figure~\ref{fig:config}.
%% アクターモデルの操作的意味を configuration のラベル付き遷移システムとして定式化する。
%% これ以降用いる記号を図\ref{fig:config}のように定義する。

\begin{figure}[t]
  \begin{displaymath}
    \begin{array}{rclcl}
      c & \in & \textit{Configuration} & =   & \textit{Set(InFlight)} \times \textit{Set(Actor)} \\
      a & \in & \textit{Actor}  & =   & \textit{Name} \times \textit{Actions} \times \mathbb{N} \\
      n & \in & \textit{Name}   & ::= & \textsf{toplevel}(s) \mid \textsf{generated}(g, n) \\
      m & \in & \textit{Message} & =  & \textit{Name} + \textit{PrimVal} + \\
        &     &                 &     & \textit{Message} \times \cdots \times \textit{Message} \\
      i & \in & \textit{InFlight} & = & \textit{Name} \times \textit{Name} \times \textit{Message} \\
      b & \in & \textit{Behavior} & = & \textit{Message} \rightarrow \textit{Actions} \\
      \alpha & \in & \textit{Actions} & ::= & \textsf{send}(n, m, \alpha) \\
        &     &                 &   | & \textsf{new}(b, \kappa) \\
        &     &                 &   | & \textsf{self}(\kappa) \\
        &     &                 &   | & \textsf{become}(b) \\
      l & \in & \textit{Label}  & ::= & \textsf{Receive}(n, n, m) \\
        &     &                 &   | & \textsf{Send}(n, n, m) \\
        &     &                 &   | & \textsf{New}(n) \\
        &     &                 &   | & \textsf{Self}(n) \\
      \kappa & \in & \textit{Name} \rightarrow \textit{Actions} & & \\
      g & \in & \mathbb{N} & &
    \end{array}
  \end{displaymath}
  \caption{Configuration}\label{fig:config}
\end{figure}

The labeled transition system used in Actario is defined like Figure~\ref{fig:semantics}.
The explanations for each of transitions are the followings.
%% このラベル一つ一つに対応した意味論は図\ref{semantics}にある。
%% receive はメッセージ待ち状態にあるアクターが、自身に向けて送られたメッセージを受け取り、アクションの列を生成する遷移である。

\begin{description}[style=nextline,leftmargin=12pt,parsep=0pt]
\item[\textsc{Receive}]
  \textsc{Receive} is the transition for \textsf{Receive} label.
  The actor which is ready to receive a message, in other words, the actor whose remaining actions are only \textsf{become}, receives a message and generate new remaining actions decided by the behavior and the content of the message.
\item[\textsc{Send}]
  \textsc{Send} is the transition for \textsf{Send} label.
  The actor which want to send a message sends a message, and then the message is added into messages in flight.
\item[\textsc{New}]
  \textsc{New} is the transition for \textsf{New} label.
  An actor generates its child actor by the given behavior.
  And then, do the followings:
  \begin{itemize}
  \item The child actor is added into the configuration. The next generation number of child actor is 0.
  \item The next generation number of the parent actor increases by 1.
  \item The child actor is ready to receive a message.
  \end{itemize}
\item[\textsc{Self}]
  \textsc{Self} is the transition for \textsf{Self} label.
  An actor gets the self name and applies it to the continuation.
\end{description}

The definition in Actario is in Appendix \ref{app:lts}.

\begin{figure*}[t]
  \begin{displaymath}
    \begin{array}{rcl}
      (I \uplus \{(n_{\textrm{to}}, n_{\textrm{from}}, m)\}, A \cup \{(n_{\textrm{to}}, \textsf{become}(b), g)\}) &
      \overset{\textsf{Receive}(n_{\textrm{to}}, n_{\textrm{from}}, m)}{\leadsto} &
      (I, A \cup \{(n_{\textrm{to}}, b(m), g)\})
      \hfill \textsc{(Receive)} \\[1ex]

      (I, A \cup \{(n_{\textrm{from}}, \textsf{send}(n_{\textrm{to}}, m, \alpha), g)\}) &
      \overset{\textsf{Send}(n_{\textrm{from}}, n_{\textrm{to}}, m)}{\leadsto} &
      (I \uplus \{(n_{\textrm{to}}, n_{\textrm{from}}, m)\}, A \cup \{(n_{\textrm{from}}, \alpha, g)\}) \\
      & & \hfill \textsc{(Send)} \\[1ex]

      (I, A \cup \{(n, \textsf{new}(b, \kappa), g)\}) &
      \overset{\textsf{New}(n')}{\leadsto} &
      (I, A \cup \{(n, \kappa(n'), g + 1), (n', \textsf{become}(b), 0)\}) \\
      & & \hfill \textrm{where}\ n' := \textsf{generated}(g, n) \\
      & & \hfill \textsc{(New)} \\[1ex]

      (I, A \cup \{(n, \textsf{self}(\kappa), g)\}) &
      \overset{\textsf{Self}(n)}{\leadsto} &
      (I, A \cup \{n, \kappa(n), g\})
      \hfill \textsc{(Self)}
    \end{array}
  \end{displaymath}
  \caption{labeled transition semantics}\label{fig:semantics}
\end{figure*}
